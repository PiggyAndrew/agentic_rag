# Agentic RAG 中间件开发计划

## 目标
- 提升对话稳定性与可观测性，控制工具使用与上下文规模。
- 与现有架构保持最小改动：不影响工具与提示词，尽量使用内置中间件。

## 采纳的内置中间件（优先启用）
- Summarization：当上下文接近阈值时，自动摘要旧消息，保留近期消息。
- Tool Call Limit：限制每轮工具调用次数，防止无界检索与细读循环。
- Tool Retry：对可恢复的工具失败（超时、临时网络波动）进行重试。
- Context Editing：在模型调用前裁剪/清理上下文，保持相关性与性能。

## 配置原则
- 与提示词规则一致：工具调用上限与提示中约束对齐（例如 4 次）。
- 成本与时延控制：摘要模型选轻量（或复用当前模型），触发阈值合理（如 tokens≈4000）。
- 错误分级：可恢复错误重试，硬错误（404/鉴权失败）直接反馈并建议修复。

## 集成方案
- 在 `create_agent` 时传入 `middleware=[...]`；保持工具与提示词逻辑不变。
- 结构化输出：使用 `ToolStrategy(schema=RAGAnswer)`，强制输出为 JSON 模式。
- 持久化托管：在 LangGraph 开发服务下不传自定义 `checkpointer/store`，使用平台内置。

## 验证与调参
- 通过 LangSmith Studio 观察每步提示、工具参数与耗时，调整触发与保留阈值。
- 针对知识库规模与问题复杂度，微调调用上限与裁剪策略。